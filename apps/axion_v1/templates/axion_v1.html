{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Axion AI - The Strongest AI Coding</title> 
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
  <style>
    html, body {
      height: 100%;
      background-color: #05070d;
      color: #e5e7eb;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
    }
    main { height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    #chat-box { flex: 1; overflow-y: auto; scroll-behavior: smooth; padding-bottom: 100px; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 4px; }
    .avatar-ai, .avatar-user { overflow: hidden; border-radius: 9999px; }
    .typing-dot { width: 6px; height: 6px; margin: 0 2px; background: #9ca3af; border-radius: 50%; display: inline-block; animation: blink 1.4s infinite both; }
    .typing-dot:nth-child(2){animation-delay:.2s;} .typing-dot:nth-child(3){animation-delay:.4s;}
    @keyframes blink{0%,80%,100%{opacity:.3;}40%{opacity:1;}}
    pre code { display: block; padding: 0.75rem; border-radius: 0.5rem; background: #1e293b !important; color: #e5e7eb; font-size: 0.9rem; overflow-x: auto; }

    @media (max-width:768px){
      #sidebar{position:fixed;left:-100%;top:0;height:100%;z-index:50;transition:left .3s;}
      #sidebar.active{left:0;}
      #overlay{display:none;}
      #overlay.active{display:block;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:40;}
    }
  </style>
</head>

<body class="flex min-h-screen">
  <div id="overlay" onclick="toggleSidebar()"></div>

  <aside id="sidebar" class="w-64 bg-[#0a0f1c] border-r border-[#1e293b] flex flex-col z-50">
    <div class="p-4 flex items-center justify-between border-b border-[#1e293b]">
      <h2 class="text-lg font-semibold text-blue-400">ü§ñ Axion AI</h2> 
      <button id="newChatBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-sm px-3 py-1 rounded-lg text-white cursor-pointer">+ Baru</button>
    </div>
    <ul id="chatList" class="flex-1 overflow-y-auto divide-y divide-[#1e293b]"></ul>
    <div class="border-t border-[#1e293b] p-4 flex flex-col gap-2">
      <button type="button" onclick="clearAllChats()" class="w-full text-red-400 hover:text-red-300 bg-[#111827] hover:bg-[#1f2937] py-2 rounded-md transition">üóëÔ∏è Hapus Semua Obrolan</button>
      <p class="text-xs text-gray-600 text-center">¬© 2025 MNK Digital</p>
    </div>
  </aside>

  <main class="flex-1 flex flex-col bg-[#05070d] relative z-0">
    <div class="p-4 border-b border-[#1e293b] flex items-center justify-between">
      <h1 id="chatTitle" class="text-lg sm:text-xl font-bold text-blue-400 truncate">ü§ñ Axion AI</h1> 
      <button class="md:hidden text-gray-400 hover:text-blue-400" onclick="toggleSidebar()">‚ò∞</button>
    </div>

    <div id="chat-box" class="p-4 sm:p-6 space-y-6 overflow-y-auto">
      <p class="text-center text-gray-600 italic">Memulai percakapan dengan Axion v1...</p>
    </div>

    <form id="chat-form" onsubmit="sendPrompt(event)" class="flex items-center gap-3 border-t border-[#1e293b] p-3 sm:p-4 bg-[#0a0f1c]">
      <input id="prompt" type="text" placeholder="Ketik perintah atau pertanyaanmu..." class="flex-1 p-3 rounded-xl bg-[#111827] text-black placeholder-gray-400 border border-[#1e293b] focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-md transition-all duration-200" />
      <button type="submit" class="px-4 sm:px-5 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl text-white font-medium shadow-md transition">Kirim</button>
    </form>
  </main>

  <script>
    let chats = JSON.parse(localStorage.getItem("axion_chats")) || [];
    let currentChat = 0;
    const saveChats = () => localStorage.setItem("axion_chats", JSON.stringify(chats));
    const renderMarkdown = (text) => { try { return marked.parse(text); } catch { return text; } };

    function generateChatTitle(prompt){
      const p = prompt.toLowerCase();
      if(p.includes("laravel")) return "Laravel Framework";
      if(p.includes("django")) return "Django Project";
      if(p.includes("react")) return "React App";
      if(p.includes("python")) return "Python Script";
      if(p.includes("html")) return "Web Design";
      return prompt.split(" ").slice(0,3).join(" ").replace(/^\w/, c => c.toUpperCase());
    }

    function createMessage(role, text){
      const parsed = renderMarkdown(text);
      const isUser = role === "user";
      const align = isUser ? "justify-end" : "justify-start";
      const bubbleColor = isUser ? "bg-blue-700 text-white" : "bg-[#0d1321] text-gray-200";
      const avatar = isUser
        ? `<div class="w-9 h-9 sm:w-10 sm:h-10 avatar-user"><img src="/static/icons/user.svg" alt="User"></div>`
        : `<div class="w-9 h-9 sm:w-10 sm:h-10 avatar-ai"><img src="/static/icons/ai.svg" alt="AI"></div>`;
      const copyBtn = !isUser
        ? `<button onclick="copyText(this)" data-text="${text.replace(/"/g,'&quot;')}" class="text-xs text-blue-400 hover:text-blue-300 ml-2">üìã Salin</button>`
        : "";
      return `<div class="flex ${align} items-start gap-3">
        ${!isUser ? avatar : ""}
        <div class="max-w-[85%] sm:max-w-[75%] ${bubbleColor} p-3 sm:p-4 rounded-2xl ${isUser ? "rounded-br-none" : "rounded-bl-none"} shadow-md leading-relaxed prose prose-invert break-words relative">
          ${parsed} ${copyBtn}
        </div>
        ${isUser ? avatar : ""}
      </div>`;
    }

    function addMessage(role, text){
      const box = document.getElementById("chat-box");
      box.insertAdjacentHTML("beforeend", createMessage(role, text));
      box.scrollTo({ top: box.scrollHeight, behavior: "smooth" });
      box.querySelectorAll("pre code").forEach(block => hljs.highlightElement(block));
    }

    // Efek mengetik + highlight
    function aiTypingEffect(text){
      const box = document.getElementById("chat-box");
      const aiBubble = document.createElement("div");
      aiBubble.className = "flex justify-start items-start gap-3";
      aiBubble.innerHTML = `
        <div class="w-9 h-9 sm:w-10 sm:h-10 avatar-ai"><img src="/static/icons/ai.svg" alt="AI"></div>
        <div class="max-w-[85%] sm:max-w-[75%] bg-[#0d1321] text-gray-200 p-3 sm:p-4 rounded-2xl rounded-bl-none shadow-md leading-relaxed prose prose-invert break-words relative"></div>`;
      box.appendChild(aiBubble);
      const bubbleText = aiBubble.querySelector("div:last-child");
      let i = 0;
      const typingSpeed = 25;
      const typingInterval = setInterval(() => {
        const partial = text.slice(0, i);
        bubbleText.innerHTML = marked.parse(partial);
        box.scrollTo({ top: box.scrollHeight });
        i++;
        if(i > text.length){
          clearInterval(typingInterval);
          bubbleText.innerHTML = marked.parse(text) +
            `<button onclick="copyText(this)" data-text="${text.replace(/"/g,'&quot;')}" class="text-xs text-blue-400 hover:text-blue-300 ml-2">üìã Salin</button>`;
          bubbleText.querySelectorAll("pre code").forEach(block => hljs.highlightElement(block));
          chats[currentChat].messages.push({ role: "ai", text });
          saveChats();
        }
      }, typingSpeed);
    }

    async function sendPrompt(e){
      e.preventDefault();
      const input = document.getElementById("prompt");
      const prompt = input.value.trim();
      if(!prompt) return;

      addMessage("user", prompt);
      chats[currentChat].messages.push({ role: "user", text: prompt });

      if(!chats[currentChat].title || chats[currentChat].title === "Obrolan Baru")
        chats[currentChat].title = generateChatTitle(prompt);

      updateChatList();
      saveChats();
      input.value = "";

      const chatBox = document.getElementById("chat-box");
      const typingDiv = document.createElement("div");
      typingDiv.className = "flex items-center gap-2 text-gray-500";
      typingDiv.innerHTML = `<div class="w-9 h-9 sm:w-10 sm:h-10 avatar-ai"><img src="/static/icons/ai.svg" alt="AI"></div>
        <div><span class='typing-dot'></span><span class='typing-dot'></span><span class='typing-dot'></span></div>`;
      chatBox.appendChild(typingDiv);
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });

      try {
        const res = await fetch("/axion-v1/chat/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt }),
        });
        chatBox.removeChild(typingDiv);
        let message;
        if (!res.ok) message = `‚ö†Ô∏è Server error (${res.status})`;
        else {
          const data = await res.json().catch(() => null);
          message = data?.response || "‚ö†Ô∏è Tidak ada respon.";
        }
        aiTypingEffect(message);
      } catch {
        chatBox.removeChild(typingDiv);
        addMessage("ai", "‚ö†Ô∏è Gagal terhubung ke server.");
      }
    }

    function copyText(btn){
      const text = btn.getAttribute("data-text");
      navigator.clipboard.writeText(text).then(() => {
        btn.innerText = "‚úÖ Disalin";
        setTimeout(() => btn.innerText = "üìã Salin", 1500);
      });
    }

    function updateChatList(){
      const list = document.getElementById("chatList");
      list.innerHTML = "";
      chats.forEach((chat, i) => {
        const li = document.createElement("li");
        li.className = "p-3 hover:bg-[#111827] cursor-pointer text-gray-300";
        li.innerHTML = `<span onclick="selectChat(${i})" class="truncate block">${chat.title}</span>`;
        list.appendChild(li);
      });
    }

    function clearAllChats(){
      if(confirm("Yakin ingin menghapus semua obrolan?")){
        localStorage.removeItem("axion_chats");
        localStorage.removeItem("axion_currentChat");
        chats = [];
        currentChat = 0;
        updateChatList();
        document.getElementById("chat-box").innerHTML = `<p class='text-center text-gray-600 italic'>Semua obrolan dihapus.</p>`;
      }
    }

    function toggleSidebar(force=null){
      const sidebar=document.getElementById("sidebar");
      const overlay=document.getElementById("overlay");
      const active=force!==null?force:!sidebar.classList.contains("active");
      sidebar.classList.toggle("active",active);
      overlay.classList.toggle("active",active);
    }

    function restoreChat(){
      const savedChats = localStorage.getItem("axion_chats");
      const savedIdx = localStorage.getItem("axion_currentChat");
      chats = savedChats ? JSON.parse(savedChats) : [];
      currentChat = savedIdx ? parseInt(savedIdx, 10) : 0;
      if (currentChat >= chats.length) currentChat = 0;
      updateChatList();
      selectChat(currentChat);
    }

    function selectChat(i){
      currentChat = i;
      localStorage.setItem("axion_currentChat", i);
      const box = document.getElementById("chat-box");
      box.innerHTML = "";
      document.getElementById("chatTitle").innerText = chats[i]?.title || "Obrolan Baru";
      toggleSidebar(false);
      if(!chats[i] || !chats[i].messages.length){
        box.innerHTML = `<p class="text-center text-gray-600 italic">Mulai obrolan baru...</p>`;
        return;
      }
      chats[i].messages.forEach(m => addMessage(m.role, m.text));
    }

    document.getElementById("newChatBtn").addEventListener("click", () => {
      chats.push({ title: "Obrolan Baru", messages: [] });
      currentChat = chats.length - 1;
      saveChats();
      localStorage.setItem("axion_currentChat", currentChat);
      updateChatList();
      selectChat(currentChat);
    });

    document.addEventListener("DOMContentLoaded", () => {
      restoreChat();
      if(chats.length === 0 || (chats.length === 1 && chats[0].messages.length === 0)){
        chats = [{ title: "Obrolan Baru", messages: [] }];
        currentChat = 0;
        saveChats();
        aiTypingEffect("Hai, selamat datang di Axion AI. Saya adalah Artificial Intelligence yang dibuat untuk membantu menyelesaikan masalah.");
      }
    });

	function addMessage(role, text){
  const box = document.getElementById("chat-box");
  // Hapus teks placeholder kalau ada
  const placeholder = box.querySelector(".placeholder-text");
  if (placeholder) placeholder.remove();

  box.insertAdjacentHTML("beforeend", createMessage(role, text));
  box.scrollTo({ top: box.scrollHeight, behavior: "smooth" });
  box.querySelectorAll("pre code").forEach(block => hljs.highlightElement(block));
}

// üß© Tampilkan placeholder hanya jika chat kosong
function renderPlaceholder(){
  const box = document.getElementById("chat-box");
  box.innerHTML = `<p class="placeholder-text text-center text-gray-600 italic">Mulai obrolan baru...</p>`;
}

function selectChat(i){
  currentChat = i;
  localStorage.setItem("axion_currentChat", i);
  const box = document.getElementById("chat-box");
  box.innerHTML = "";
  document.getElementById("chatTitle").innerText = chats[i]?.title || "Obrolan Baru";
  toggleSidebar(false);

  if(!chats[i] || !chats[i].messages.length){
    renderPlaceholder();
    return;
  }
  chats[i].messages.forEach(m => addMessage(m.role, m.text));
}

// ==== Penyesuaian agar input chat tidak ketutupan keyboard ====
if (window.visualViewport) {
  const chatForm = document.getElementById("chat-form");
  const main = document.querySelector("main");

  const adjustForKeyboard = () => {
    const viewport = window.visualViewport;
    const bottomOffset = window.innerHeight - viewport.height - viewport.offsetTop;

    // Jika keyboard muncul
    if (bottomOffset > 50) {
      document.body.classList.add("keyboard-open");
      chatForm.style.bottom = `${bottomOffset}px`;
      main.style.height = `${viewport.height}px`;
      document.getElementById("chat-box").scrollTo({
        top: document.getElementById("chat-box").scrollHeight,
        behavior: "smooth"
      });
    } else {
      // Keyboard ditutup
      document.body.classList.remove("keyboard-open");
      chatForm.style.bottom = "0px";
      main.style.height = "100vh";
    }
  };

  window.visualViewport.addEventListener("resize", adjustForKeyboard);
  window.visualViewport.addEventListener("scroll", adjustForKeyboard);
}


  </script>
</body>
</html>
